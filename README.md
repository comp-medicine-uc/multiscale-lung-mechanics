# Whole-lung finite-element models for mechanical ventilation and respiratory research applications

Contact: 
_[@nbaviles](https://https://github.com/nbaviles)_
_[@dehurtado](https://github.com/dehurtado)_
_[@comp-medicine-uc](https://github.com/comp-medicine-uc)_





Numerical simulations of lung clinical applications using a large strain poroelastic model: pressure-controlled ventilation (PCV), volume-controlled ventilation (VCV) and supersyringe method

## Abstract

Mechanical ventilation has been a vital treatment for Covid-19 patients with respiratory failure. Lungs assisted with mechanical ventilators present a wide variability in their response that strongly depends on air-tissue interactions, which motivates the creation of simulation tools to enhance the design of ventilatory protocols. In this work, we aim to create anatomical computational models of the lungs that predict clinically-relevant respiratory variables. To this end, we formulate a continuum poromechanical framework that eamlessly accounts for the air-tissue interaction in the lung parenchyma. Based on this formulation, we construct anatomical finite-element models of the human lungs from computed-tomography images. We simulate the 3D response of lungs connected to mechanical ventilation, from which we recover physiological parameters of high clinical relevance. In particular, we provide a framework to estimate respiratory-system compliance and resistance from continuum lung dynamic simulations. We further study our computational framework in the simulation of the supersyringe method to construct pressure-volume curves. In addition, we run these simulations using several state-of-the-art lung tissue models to understand how the choice of constitutive models impacts the whole-organ mechanical response. We show that the proposed lung model predicts physiological variables, such as airway pressure, flow and volume, that capture many distinctive features observed in mechanical ventilation and the supersyringe method. We further conclude that some constitutive lung tissue models may not adequately capture the physiological behavior of lungs, as measured in terms of lung respiratory-system compliance. Our findings constitute a proof of concept that finite-element poromechanical models of the lungs can be predictive of clinically-relevant variables in respiratory medicine.


## Results

The main results of this research are shown below. Figure 3 shows the airway pressure, flow and volume signals predicted by the poroelastic model of the
lung during PCV simulations. 


<!---
your comment goes here
and here
<figure>
  <p align="center">
<img src="results-data/fig03_plotPCV.png"  height="80%" width="80%" alt="Alt text" title="Optional title">
<figcaption align = "center"><b> Figure 3. Simulation of lungs under pressure-controlled mechanical ventilation. Physiological signals that
describe the time evolution of airway pressure (top), flow (middle), and volume (bottom) are shown for all
constitutive models considered in this work. $\protect\overrightarrow{CM}$ t1; t2; and t3 represent the time instants for peak flow, peak
volume, and half expiratory time, respectively.</b></figcaption>
</p>
</figure>
-->







<figure>
<p align="center">
<img src="results-data/fig03_plotPCV.png"  height="100%" width="100%">
</p>
</figure>
Figure 3. Simulation of lungs under pressure-controlled mechanical ventilation. Physiological signals that
describe the time evolution of airway pressure (top), flow (middle), and volume (bottom) are shown for all
constitutive models considered in this work. $t_1$; $t_2$; and $t_3$ represent the time instants for peak flow, peak
volume, and half expiratory time, respectively 
<br/><br/><br/><br/>



The respiratory system compliance and resistance for the five constitutive models studied
obtained from fitting the equation of motion to the PCV finite-element simulations are reported in Table 2. 
<br/><br/>

Table 2. Respiratory system compliance and resistance for each model from the adjustment of the equation
of motion to the computed waveforms
<div align="center">

| CM | $\text{C}_\text{rs}$  (ml/cm $H_2O$) | R (cm $H_2O \cdot L/s$ )|
| :---:    |   :---:      |   :---: |
| CM1  | 123    | 4.19    |
| CM2   | 100     | 4.35   |
| CM3   | 84     | 4.38    |
| CM4   | 38     | 4.47    |
| CM5   | 15       | 4.55   
  
</div>


<br/><br/><br/><br/>


The predictions of lung respiratory signals generated by our finite-element model using the CM3
constitutive law were compared with those predicted by a single-compartment lung model, see Figure 4.

<figure>
<p align="center">
<img src="results-data/fig04_plotCOMPA.png"  height="50%" width="50%">
</p>
</figure>
Figure 4. Comparison of respiratory variable evolution as predicted by finite-element simulations (CM3
model) and single-compartment model.
<br/><br/><br/><br/>

The temporal evolution of the jacobian and alveolar pressure fields during PCV respiratory cycle for all the constitutive models considered is reported in Figure 5. We studied three key time instants to make comparisons between the models analyzed: time of peak flow  ( $t_1$ in Figure 3), time of peak volume/end of
inspiration ( $t_2$ in Figure 3), and time when half of the expiration subcycle has passed ( $t_3$ in Figure 3).

<figure>
<p align="center">
<img src="results-data/fig05_cortes_jacpres.png"  height="100%" width="100%">
 </p>
</figure>
Figure 5. Temporal evolution of all lung models during one respiratory cycle of pressure-controlled
mechanical ventilation: (a) jacobian field, and (b) alveolar pressure field. Fields are plotted in the current
configuration.
<br/><br/><br/><br/>


To study the evolution of stress fields in our lung simulations, we considered the effective hydrostatic and von Mises stress tensor invariants. Figure 6(a) reports the the temporal evolution of the (effective) hydrostatic stress fields. Figure 6(b) shows the evolution of the (effective) von Mises stress.
<figure>
<p align="center">
<img src="results-data/fig06_cortes_tensiones.png"  height="100%" width="100%">
 </p>
</figure>
Figure 6. Temporal evolution of all lung models during one respiratory cycle of pressure-controlled
mechanical ventilation: (a) Hydrostatic stress field, and (b) von Misses stress field. Fields are plotted in the
current configuration.
<br/><br/><br/><br/>


The performance of our finite element model was also evaluated by predicting signals in the VCV mode.
 Figure 7 shows the airway pressure, flow, and volume signals for all the studied models.
 
<figure>
<p align="center">
<img src="results-data/fig07_plotVCV.png"  height="100%" width="100%">
 </p>
</figure>
Figure 7. Simulation of lungs under volume-controlled mechanical ventilation. Physiological signals that
describe the time evolution of airway pressure (top), flow (middle), and volume (bottom) are shown for all
constitutive models considered in this work. The y-axis was broken for the clarity of the plot.
<br/><br/><br/><br/>


Figure 8 shows the results from simulations of the supersyringe method. The time evolution of the airway
pressure as a response to increments of inspiratory volume is shown in Figure 8(a). Figure 8(b) shows the P-V lung
curves for all models analyzed.
<figure>
<p align="center">
<img src="results-data/fig08_superpv.png"  height="100%" width="100%">
 </p>
</figure>
Figure 8. Simulation of lungs being studied with the supersyringe method. (a) Airway pressure versus
time during the volume-controlled inflation-deflation protocol. (b) Pressure-volume curves for inflation and
deflation processes. Solid lines show the pressure-volume evolution during the dynamic process. Dotted
lines indicate the resulting quasi-static P-V curves for each constitutive model considered.
<br/><br/><br/><br/>

Finally, we also compute the lung compliance for each constitutive model, see Table 3.
<br/><br/>

Table 3. Lung compliance for each model (unrestrained lung)
<div align="center">

  | CM | $\text{C}_\text{l}$ (ml/cm $H_2O$)  | 
| :---:    |   :---:      |   
| CM1  | 358    | 
| CM2   | 256     | 
| CM3   | 195     | 
| CM4   | 57     | 
| CM5   | 17    
  
</div>


<br/><br/><br/><br/>

## Directories

- `manuscript`: Files pertaining to the article related to this project.
- `presentations`: Files pertaining to presentations of this project.
- `raw-data`: Input data needed for simulations + Output raw data.
- `results-data`: Data processed from `raw-data`.
- `src`: Source files.
- `tests`: Main files that implement examples and tests.

## Dependencies

Coded in Python 3.8.2 64-bit. 

Used libraries:

- [`FEniCS`](https://fenicsproject.org/) 2019.1.0
- `CGAL`
- `numpy`
- `scipy`
- `matplotlib`
- `os`
- `meshio` 4.4.6
- `nibabel`
- `pyvista`
